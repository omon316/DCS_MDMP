<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCS Planungstool - Milestone 3</title>
  <style>
    /* ========= CSS Variablen & Grundstile ========= */
    :root {
      --bg-color: #1e1e2e;
      --fg-color: #d4d4d4;
      --bar-bg: #252525;
      --btn-bg: #333;
      --btn-active: #007acc;
      --window-bg: #2a2a2a;
      --header-bg: #333;
      --highlight: #e74c3c;
    }
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      height: 100%; overflow: hidden;
      background: var(--bg-color); color: var(--fg-color);
      font-family: sans-serif;
    }
    /* ===== Top-Bar ===== */
    .top-bar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 44px; background: var(--bar-bg);
      display: flex; align-items: center;
      padding: 0 12px; z-index: 100;
    }
    .top-bar label { margin-right: 6px; }
    .top-bar input, .top-bar select {
      margin-right: 8px;
      background: var(--btn-bg); border: 1px solid #333; border-radius: 2px;
      padding: 4px 6px; color: var(--fg-color);
    }
    .top-bar button {
      margin-right: 8px;
      background: var(--btn-bg); border: 1px solid #333; border-radius: 2px;
      padding: 4px 8px; color: var(--fg-color); cursor: pointer;
    }
    .top-bar-right { margin-left: auto; display: flex; align-items: center; }
    #status-msg { margin-left: 8px; font-size: 0.9em; }
    /* ===== Sidebar ===== */
    .left-panel {
      position: fixed; top: 44px; left: 0; right: 0;
      display: flex; background: var(--bar-bg); padding: 4px;
      z-index: 99;
    }
    .left-panel button {
      flex: 1; margin-right: 4px;
      background: var(--btn-bg); border: none;
      padding: 6px; color: var(--fg-color); cursor: pointer;
    }
    .left-panel button:last-child { margin-right: 0; }
    .left-panel button.active {
      background: var(--btn-active); color: #fff;
    }
    /* ===== Editor-Mode Button ===== */
    .editor-mode-button {
      position: fixed; bottom: 12px; left: 12px;
      background: var(--btn-active); border: none;
      padding: 6px 12px; color: #fff; cursor: pointer;
      z-index: 200;
    }
    body.editor-mode .editor-mode-button {
      background: var(--highlight);
    }
    #editor-mode-info {
      display: none;
      position: fixed; top: 0; left: 50%; transform: translateX(-50%);
      height: 44px; line-height: 44px;
      background: var(--highlight); padding: 0 12px;
      color: #fff; font-weight: bold;
      z-index: 200;
    }
    body.editor-mode #editor-mode-info { display: block; }
    /* ===== Container & Map ===== */
    .container {
      position: absolute; top: 96px; bottom: 0;
      left: 0; right: 0; overflow: auto;
    }
    .map-area {
      position: relative; user-select: none;
      padding: 16px; background: transparent;
    }
    .map-drop {
      display: none; pointer-events: none;
      position: absolute; top: 0; left: 8px; right: 8px;
      height: 80px; border: 2px dashed #777;
      color: #777; align-items: center; justify-content: center;
    }
    body.editor-mode .map-drop {
      display: flex; pointer-events: auto;
    }
    /* ===== Fenster ===== */
    .floating-window {
      position: absolute; width: 533px; height: 400px;
      background: var(--window-bg); border: 1px solid #333;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.4); border-radius: 4px;
      display: flex; flex-direction: column;
      z-index: 150; resize: both; overflow: auto;
    }
    .window-taskbar {
      background: var(--header-bg); padding: 6px 8px;
      display: flex; align-items: center;
      cursor: grab; user-select: none;
    }
    .window-taskbar span { flex: 1; color: #fff; }
    .window-taskbar button {
      background: transparent; border: none;
      color: #fff; font-size: 1em; cursor: pointer;
    }
    .window-tabs {
      display: flex; gap: 4px;
      background: #2b2b2b; padding: 4px;
    }
    .window-tab {
      display: flex; align-items: center;
      background: var(--btn-bg); color: var(--fg-color);
      padding: 4px 8px; border-radius: 3px; cursor: move;
      position: relative;
    }
    .window-tab.active {
      background: var(--btn-active); color: #fff;
    }
    .window-tab input {
      background: transparent; border: none;
      color: inherit; outline: none;
      width: auto;
    }
    .window-tab .tab-close {
      margin-left: 4px; background: transparent;
      border: none; color: #ccc; cursor: pointer;
    }
    .add-tab { display: none; }
    body.editor-mode .add-tab {
      display: flex; align-items: center;
      justify-content: center; padding: 4px 8px;
      background: #555; border-radius: 3px;
      color: #fff; cursor: pointer; margin-left: 4px;
    }
    .editor-toolbar {
      display: none; gap: 6px;
      background: rgba(255,255,255,0.1); padding: 4px 8px;
      border-radius: 4px; margin: 4px;
    }
    body.editor-mode .editor-toolbar { display: flex; }
    .editor-toolbar button {
      background: transparent; border: none;
      color: var(--fg-color); padding: 4px 6px;
      cursor: pointer;
    }
    .page { flex: 1; padding: 10px; position: relative; overflow: auto; }
    .page-content {
      width: 100%; height: 100%; padding: 4px;
      box-sizing: border-box; background: transparent;
      color: var(--fg-color); outline: none;
    }
    .page[data-drop-zone]::before {
      content: "+ Bild hierher ziehen";
      position: absolute; top:50%; left:50%;
      transform: translate(-50%,-50%);
      border: 2px dashed #777; padding: 10px;
      border-radius: 5px; color: #777;
      display: none;
    }
    body.editor-mode .page[data-drop-zone]::before { display: block; }
    .img-controls {
      position: absolute; top: 6px; right: 6px;
      display: flex; gap: 4px;
    }
    .img-controls button {
      background: rgba(0,0,0,0.5); border: none;
      color: #fff; padding: 2px 6px; cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Top-Bar -->
  <div class="top-bar">
    <label for="mission-name">OPERATION:</label>
    <input id="mission-name" type="text" placeholder="Missionsname">
    <label for="map-select">Map:</label>
    <select id="map-select"></select>
    <span id="map-display"></span>
    <div class="top-bar-right">
      <label for="takeoff-date">Mission Start:</label>
      <input id="takeoff-date" type="date">
      <input id="takeoff-time" type="time">
      <button id="save-btn">Save</button>
      <button id="load-btn">Load</button>
      <input id="load-input" type="file" accept="application/json" style="display:none">
      <span id="status-msg"></span>
    </div>
  </div>
  <div id="editor-mode-info">Editor Mode</div>

  <!-- Sidebar -->
  <div class="left-panel">
    <button data-window="threats">Threats</button>
    <button data-window="situation">Situation</button>
    <button data-window="mission">Mission</button>
    <button data-window="package">Package</button>
    <button data-window="flightplan">Flightplan</button>
    <button data-window="agencies">Agencies</button>
    <button data-window="charts">Charts</button>
    <button data-window="commladder">Comm Ladder</button>
  </div>

  <!-- Hauptbereich -->
  <div class="container">
    <div class="map-area">
      <div class="map-drop"></div>
    </div>
  </div>

  <button id="editor-mode-button" class="editor-mode-button">Editor Mode</button>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialisierung
    const now = new Date();
    const D = String(now.getDate()).padStart(2,'0');
    const H = String(now.getHours()).padStart(2,'0');
    const M = String(now.getMinutes()).padStart(2,'0');
    const STORAGE_KEY = `dcs-plan_${D}-${H}-${M}`;

    let state = {
      missionName: '',
      map: '',
      missionStartDate: '',
      missionStartTime: '',
      windows: {},
      mapImages: []
    };

    // DOM-Referenzen
    const missionInput = document.getElementById('mission-name');
    const mapSelect    = document.getElementById('map-select');
    const mapDisplay   = document.getElementById('map-display');
    const dateInput    = document.getElementById('takeoff-date');
    const timeInput    = document.getElementById('takeoff-time');
    const saveBtn      = document.getElementById('save-btn');
    const loadBtn      = document.getElementById('load-btn');
    const loadInput    = document.getElementById('load-input');
    const statusMsg    = document.getElementById('status-msg');
    const editorBtn    = document.getElementById('editor-mode-button');
    const mapDrop      = document.querySelector('.map-drop');
    const sidebarBtns  = document.querySelectorAll('.left-panel button');
    let openWindows = {}, editorMode = false;

    // Felder binden
    missionInput.value = state.missionName;
    missionInput.addEventListener('input', () => state.missionName = missionInput.value);

    ['Caucasus','Afghanistan','Persian Gulf','Iraq','Syria','Kola','Europe','NTTR','South Pacific']
      .forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; mapSelect.append(opt); });
    mapSelect.value = state.map;
    mapSelect.addEventListener('change', () => { state.map = mapSelect.value; mapDisplay.textContent = state.map; });
    mapDisplay.textContent = state.map;

    dateInput.value = state.missionStartDate;
    dateInput.addEventListener('change', () => state.missionStartDate = dateInput.value);
    timeInput.value = state.missionStartTime;
    timeInput.addEventListener('change', () => state.missionStartTime = timeInput.value);

    // Editor-Modus umschalten
    editorBtn.addEventListener('click', () => {
      editorMode = !editorMode;
      document.body.classList.toggle('editor-mode', editorMode);
      document.getElementById('editor-mode-info').textContent = editorMode ? 'Editor Mode' : 'View Mode';
      // contentEditable umschalten
      document.querySelectorAll('.page-content').forEach(div => div.contentEditable = editorMode);
    });

    // Sidebar-Buttons
    sidebarBtns.forEach(btn => btn.addEventListener('click', () => {
      const key = btn.dataset.window;
      if(openWindows[key]) {
        const w = openWindows[key];
        w.style.display = w.style.display === 'none' ? 'flex' : 'none';
        btn.classList.toggle('active');
      } else {
        const w = createWindow(key, btn.textContent, btn);
        document.body.appendChild(w);
        openWindows[key] = w;
        btn.classList.add('active');
      }
    }));

    // Map-Drop
    mapDrop.addEventListener('dragover', e => { if(editorMode) e.preventDefault();
    });
    mapDrop.addEventListener('drop', e => {
      e.preventDefault(); if(!editorMode) return;
      handleDrop(e, document.querySelector('.map-area'), null);
    });

    // Speichern
    saveBtn.addEventListener('click', () => {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `${STORAGE_KEY}.json`;
      a.click(); URL.revokeObjectURL(a.href);
      statusMsg.textContent = 'Saved';
    });

    // Laden
    loadBtn.addEventListener('click', () => loadInput.click());
    loadInput.addEventListener('change', e => {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev => {
        try {
          state = JSON.parse(ev.target.result);
          // Felder wiederherstellen
          missionInput.value = state.missionName;
          mapSelect.value = state.map; mapDisplay.textContent = state.map;
          dateInput.value = state.missionStartDate;
          timeInput.value = state.missionStartTime;
          statusMsg.textContent = 'Loaded';
          // Fenster & Bilder
          clearWindows(); rebuildWindows();
          state.mapImages.forEach(img => {
            const { wrapper } = createImageElement(img, document.querySelector('.map-area'), null);
            document.querySelector('.map-area').appendChild(wrapper);
          });
        } catch {
          statusMsg.textContent = 'Error loading JSON';
        }
      };
      r.readAsText(f);
    });

    // Fenster-Funktionen
    function clearWindows() {
      Object.values(openWindows).forEach(w => w.remove());
      openWindows = {};
      sidebarBtns.forEach(b => b.classList.remove('active'));
    }
    function rebuildWindows() {
      Object.entries(state.windows).forEach(([id, cfg]) => {
        const btn = document.querySelector(`[data-window="${id}"]`);
        const w = createWindow(id, cfg.title, btn, cfg);
        document.body.appendChild(w);
        openWindows[id] = w;
        btn.classList.add('active');
      });
    }

    function createWindow(id, title, srcBtn, cfg) {
      const idx = Object.keys(openWindows).length;
      const defaultX = 50 + idx * 20;
      const defaultY = 60 + idx * 20;
      const winCfg = cfg || { title, tabs: [{ label: title, content: '', images: [] }], active: 0, x: defaultX, y: defaultY };
      state.windows[id] = winCfg;
      const win = document.createElement('div'); win.className = 'floating-window';
      win.style.left = winCfg.x + 'px'; win.style.top = winCfg.y + 'px'; win.style.display = 'flex';
      // Header
      const header = document.createElement('div'); header.className = 'window-taskbar';
      const lbl = document.createElement('span'); lbl.textContent = winCfg.title;
      const cb = document.createElement('button'); cb.textContent = '✕'; cb.onclick = () => { win.style.display = 'none'; srcBtn.classList.remove('active'); };
      header.append(lbl, cb); win.append(header);
      // Tabs
      const tabsEl = document.createElement('div'); tabsEl.className = 'window-tabs';
      const addEl = document.createElement('div'); addEl.className = 'add-tab'; addEl.textContent = '+';
      addEl.onclick = () => { if(editorMode) addPage(); };
      tabsEl.append(	addEl ); win.append(tabsEl);
      // Toolbar
      const toolbar = document.createElement('div'); toolbar.className = 'editor-toolbar';
      toolbar.innerHTML = '<button data-cmd="bold"><b>B</b></button><button data-cmd="increase">A+</button><button data-cmd="decrease">A-</button>';
      toolbar.querySelectorAll('button').forEach(b => {
        b.onmousedown = e => {
          e.preventDefault(); const cmd = b.getAttribute('data-cmd');
          document.execCommand(cmd==='bold'?'bold':'fontSize', false, cmd==='increase'?'5':'3');
        };
      });
      win.append(toolbar);
      // Pages
      const pages = []; let current = winCfg.active;
      function createPage(tab) {
        const page = document.createElement('div'); page.className = 'page'; page.setAttribute('data-drop-zone','true'); page.style.display = 'none';
        const div = document.createElement('div'); div.className = 'page-content'; div.innerHTML = tab.content; div.contentEditable = editorMode;
        div.oninput = () => { tab.content = div.innerHTML; };
        page.append(div);
        tab.images.forEach(img => { const { wrapper } = createImageElement(img, page, tab); page.append(wrapper); });
        page.ondragover = e => { if(editorMode) e.preventDefault(); };
        page.ondrop = e => { if(editorMode) handleDrop(e, page, tab); };
        win.append(page); return { page, div };
      }
      function renderTabs() { tabsEl.querySelectorAll('.window-tab').forEach(n=>n.remove());
        winCfg.tabs.forEach((t,i) => {
          const te = document.createElement('div'); te.className = 'window-tab'; te.draggable = true;
          const inp = document.createElement('input'); inp.value = t.label; inp.readOnly = !editorMode;
          inp.oninput = () => { t.label = inp.value; };
          const x = document.createElement('button'); x.className = 'tab-close'; x.textContent = '✕';
          x.onclick = e => { e.stopPropagation(); winCfg.tabs.splice(i,1); pages.splice(i,1); if(current===i) current=0; renderTabs(); switchPage(current); };
          te.append(inp, x);
          te.ondragstart = e => e.dataTransfer.setData('tab-index', i);
          te.ondragover = e => e.preventDefault();
          te.ondrop = e => { e.preventDefault(); const from = +e.dataTransfer.getData('tab-index'); winCfg.tabs.splice(i,0, winCfg.tabs.splice(from,1)[0]); renderTabs(); switchPage(i); };
          te.onclick = () => switchPage(i);
          tabsEl.insertBefore(te, addEl);
        });
      }
      function switchPage(i) { current = i; winCfg.active = i; renderTabs(); pages.forEach((p,idx) => p.page.style.display = idx===i?'block':'none'); }
      function addPage() { winCfg.tabs.push({ label: 'Seite '+winCfg.tabs.length, content: '', images: [] }); const p = createPage(winCfg.tabs[winCfg.tabs.length-1]); pages.push(p); renderTabs(); switchPage(pages.length-1); }
      winCfg.tabs.forEach(tab => pages.push(createPage(tab)));
      renderTabs(); switchPage(current);
      makeDraggable(win, header, id);
      return win;
    }
    function handleDrop(e, container, tab) {
      e.preventDefault(); const f = e.dataTransfer.files[0]; if(!f||!f.type.startsWith('image/')) return;
      const r = new FileReader(); r.onload = ev => {
        const src = ev.target.result;
        if(tab) tab.images.push({ src }); else state.mapImages.push({ src });
        const { wrapper } = createImageElement({ src }, container, tab);
        container.appendChild(wrapper);
        if(!tab) container.appendChild(mapDrop);
      };
      r.readAsDataURL(f);
    }
    function createImageElement(imgData, container, tab) {
      const wrapper = document.createElement('div'); wrapper.style.position='relative'; wrapper.style.marginBottom='8px';
      const img = document.createElement('img'); img.src = imgData.src; img.style.width='100%';
      const ctrls = document.createElement('div'); ctrls.className='img-controls';
      ctrls.innerHTML = '<button class="del">✕</button><button class="toggle">⛶</button><button class="up">↑</button><button class="down">↓</button>';
      ctrls.querySelector('.del').onclick = () => { wrapper.remove(); if(tab) tab.images=tab.images.filter(i=>i.src!==imgData.src); else state.mapImages=state.mapImages.filter(i=>i.src!==imgData.src); };
      let full=false;
      ctrls.querySelector('.toggle').onclick = () => { full=!full; img.style.width = full?'auto':'100%'; img.style.maxHeight = full?'none':'100%'; };
      ctrls.querySelector('.up').onclick = () => { const p=wrapper.parentNode; if(p&&wrapper.previousElementSibling) p.insertBefore(wrapper,wrapper.previousElementSibling); };
      ctrls.querySelector('.down').onclick = () => { const p=wrapper.parentNode; if(p&&wrapper.nextElementSibling) p.insertBefore(wrapper.nextElementSibling,wrapper); };
      wrapper.append(img, ctrls); return { wrapper, img, ctrls };
    }
    function makeDraggable(el, hdl, id) {
      let dragging=false, ox=0, oy=0;
      hdl.onmousedown = e => { dragging=true; ox = e.clientX - el.offsetLeft; oy = e.clientY - el.offsetTop; };
      document.onmousemove = e => { if(dragging) { el.style.left = (e.clientX - ox)+'px'; el.style.top = (e.clientY - oy)+'px'; } };
      document.onmouseup = () => { if(dragging) { dragging=false; state.windows[id].x = parseInt(el.style.left); state.windows[id].y = parseInt(el.style.top); } };
    }
  });
  </script>
</body>
</html>
